name: Deploy Theme

on:
  push:
    branches: [main]
    paths:
      - 'themes/**'
  workflow_dispatch:

env:
  THEME_NAME: chris-theme
  GHOST_PATH: /var/www/ghost
  SITE_URL: https://chris.dilger.me

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install gscan
        run: npm install -g gscan

      - name: Validate theme
        run: gscan themes/${{ env.THEME_NAME }} --verbose

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Backup current theme
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "
            THEME_PATH=${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}
            BACKUP_PATH=${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}.backup

            # Remove old backup if exists
            rm -rf \$BACKUP_PATH

            # Create backup of current theme if it exists
            if [ -d \$THEME_PATH ]; then
              cp -r \$THEME_PATH \$BACKUP_PATH
              echo 'Backup created'
            else
              echo 'No existing theme to backup'
            fi
          "

      - name: Deploy theme
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            themes/${{ env.THEME_NAME }}/ \
            root@${{ secrets.VPS_HOST }}:${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}/

      - name: Fix ownership
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "
            chown -R ghost:ghost ${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}
          "

      - name: Restart Ghost
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "
            cd ${{ env.GHOST_PATH }}
            sudo -u chris ghost restart
          "

      - name: Health check
        id: health
        run: |
          echo 'Waiting for Ghost to restart...'
          sleep 10

          # Try up to 6 times (60 seconds total)
          for i in 1 2 3 4 5 6; do
            HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' ${{ env.SITE_URL }} || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "Site is healthy!"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep 10
          done

          echo "Site health check failed!"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Rollback on failure
        if: failure() && steps.health.outputs.healthy == 'false'
        run: |
          echo "Rolling back to previous theme..."
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "
            THEME_PATH=${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}
            BACKUP_PATH=${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}.backup

            if [ -d \$BACKUP_PATH ]; then
              rm -rf \$THEME_PATH
              mv \$BACKUP_PATH \$THEME_PATH
              chown -R ghost:ghost \$THEME_PATH
              cd ${{ env.GHOST_PATH }}
              sudo -u chris ghost restart
              echo 'Rollback complete'
            else
              echo 'No backup available for rollback'
            fi
          "

          # Verify rollback worked
          sleep 10
          HTTP_CODE=$(curl -s -o /dev/null -w '%{http_code}' ${{ env.SITE_URL }} || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Rollback successful - site is back online"
          else
            echo "WARNING: Site still not responding after rollback"
          fi

      - name: Cleanup backup on success
        if: success()
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.VPS_HOST }} "
            rm -rf ${{ env.GHOST_PATH }}/content/themes/${{ env.THEME_NAME }}.backup
            echo 'Backup cleaned up'
          "
